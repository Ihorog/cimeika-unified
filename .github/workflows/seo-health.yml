name: seo-health

on:
  # Ð’Ñ€ÑƒÑ‡Ð½Ñƒ
  workflow_dispatch:
  
  # Ð©Ð¾Ñ‚Ð¸Ð¶Ð½Ñ: Ð¿Ð¾Ð½ÐµÐ´Ñ–Ð»Ð¾Ðº 06:00 UTC (09:00 Europe/Kyiv)
  schedule:
    - cron: '0 6 * * 1'
  
  # ÐŸÑ€Ð¸ Ð·Ð¼Ñ–Ð½Ð°Ñ… Ð² SEO ÐºÐ¾Ð½Ñ„Ñ–Ð³Ð°Ñ… Ð°Ð±Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°Ñ…
  push:
    branches:
      - main
    paths:
      - '.governance/seo/**'
      - 'scripts/seo/**'

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    name: SEO Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate SEO health report
        id: health_report
        run: |
          node scripts/seo/seo_health_report.mjs
          
          # Ð§Ð¸Ñ‚Ð°Ñ”Ð¼Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð´Ð»Ñ Ð½Ð°ÑÑ‚ÑƒÐ¿Ð½Ð¸Ñ… ÐºÑ€Ð¾ÐºÑ–Ð²
          if [ -f health_report.json ]; then
            AUTO_TICKET_REQUIRED=$(cat health_report.json | grep -o '"required": true' || echo "")
            if [ -n "$AUTO_TICKET_REQUIRED" ]; then
              echo "auto_ticket_needed=true" >> $GITHUB_OUTPUT
              
              # Ð’Ð¸Ñ‚ÑÐ³ÑƒÑ”Ð¼Ð¾ Ð´Ð°Ð½Ñ– Ð´Ð»Ñ issue
              DRIFT_PERCENT=$(cat health_report.json | grep -o '"drift_percent": [0-9.]*' | grep -o '[0-9.]*')
              TOLERANCE_PERCENT=$(cat health_report.json | grep -o '"tolerance_percent": [0-9.]*' | grep -o '[0-9.]*')
              echo "drift_percent=$DRIFT_PERCENT" >> $GITHUB_OUTPUT
              echo "tolerance_percent=$TOLERANCE_PERCENT" >> $GITHUB_OUTPUT
            else
              echo "auto_ticket_needed=false" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Upload health reports
        uses: actions/upload-artifact@v4
        with:
          name: seo-health-reports
          path: |
            health_report.json
            health_report.md
          retention-days: 90
      
      - name: Create auto-ticket for drift
        if: steps.health_report.outputs.auto_ticket_needed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('health_report.json', 'utf8'));
            
            const title = `SEO: Indexation drift > tolerance`;
            const body = `## ðŸš¨ SEO Indexation Drift Alert
            
            ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð¾ governance loop ÑÐ¸ÑÑ‚ÐµÐ¼Ð¾ÑŽ.
            
            ### Ð”ÐµÑ‚Ð°Ð»Ñ–
            
            - **Timestamp:** ${report.timestamp_iso}
            - **Drift:** ${report.checks.indexation_drift.drift_percent.toFixed(2)}%
            - **Tolerance:** ${report.checks.indexation_drift.tolerance_percent}%
            - **Matrix Version:** ${report.matrix_version}
            
            ### ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°
            
            ${report.actions.auto_ticket.reason}
            
            ### Next Steps
            
            1. ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ð¸Ñ‚Ð¸ Ð»Ð¾Ð³Ð¸ Ñ–Ð½Ð´ÐµÐºÑÐ°Ñ†Ñ–Ñ— Ð² Google Search Console
            2. ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ñ–Ð·ÑƒÐ²Ð°Ñ‚Ð¸ robots.txt Ñ‚Ð° sitemap.xml
            3. ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ð¸Ñ‚Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð½Ñ– Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ¸ (5xx) Ñ‚Ð° Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ–ÑÑ‚ÑŒ ÑÑ‚Ð¾Ñ€Ñ–Ð½Ð¾Ðº
            4. ÐžÑ†Ñ–Ð½Ð¸Ñ‚Ð¸ Ð²Ð¿Ð»Ð¸Ð² Ð¾ÑÑ‚Ð°Ð½Ð½Ñ–Ñ… Ð·Ð¼Ñ–Ð½ Ð½Ð° ÑÐ°Ð¹Ñ‚Ñ–
            5. Ð—Ð° Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸ â€” ÐµÑÐºÐ°Ð»ÑŽÐ²Ð°Ñ‚Ð¸ Ð´Ð¾ SEO Lead
            
            ### Governance
            
            - **Decision Authority:** ${report.system_reactivity}
            - **Escalation Path:** seo_lead â†’ product_owner
            
            ---
            
            ðŸ“Š ÐŸÐ¾Ð²Ð½Ð¸Ð¹ Ð·Ð²Ñ–Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹ Ð² Artifacts workflow run.
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['seo:auto_ticket', 'governance']
            });
            
            console.log('âœ… Auto-ticket ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð¾');
      
      - name: Summary
        if: always()
        run: |
          echo "# SEO Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f health_report.md ]; then
            cat health_report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Health report Ð½Ðµ Ð·Ð³ÐµÐ½ÐµÑ€Ð¾Ð²Ð°Ð½Ð¾" >> $GITHUB_STEP_SUMMARY
          fi
