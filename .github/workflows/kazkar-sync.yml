name: Kazkar Legends Sync

on:
  push:
    branches:
      - main
    paths:
      - 'docs/legends/**.md'
      - 'frontend/src/modules/Kazkar/legends/**'
      - 'scripts/sync_legends_to_api.js'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (true/false)'
        required: false
        default: 'false'

env:
  API_URL: ${{ secrets.CIMEIKA_API_URL || 'https://ihorog-cimeika-api.hf.space' }}
  NODE_VERSION: '18'

jobs:
  sync-legends:
    name: Sync Legends to API
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd ${{ github.workspace }}
          npm install --package-lock-only || npm install

      - name: Wake up Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
        run: |
          echo "ðŸ”Œ Waking up Hugging Face Space: Ihorog/cimeika-api"
          
          # Check space status
          SPACE_STATUS=$(curl -s -H "Authorization: Bearer $HF_TOKEN" \
            "https://huggingface.co/api/spaces/Ihorog/cimeika-api" | \
            grep -o '"runtime":{"stage":"[^"]*"' | cut -d'"' -f6 || echo "unknown")
          
          echo "ðŸ“Š Current space status: $SPACE_STATUS"
          
          # Wake up if not running
          if [ "$SPACE_STATUS" != "RUNNING" ]; then
            echo "â° Sending wake-up request..."
            curl -X POST -H "Authorization: Bearer $HF_TOKEN" \
              "https://huggingface.co/api/spaces/Ihorog/cimeika-api/restart"
          fi
          
          # Wait for space to respond (up to 20 attempts Ã— 10s = 200s)
          echo "â³ Waiting for Space to become ready..."
          for i in {1..20}; do
            echo "  Attempt $i/20..."
            response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 \
              "${{ env.API_URL }}/api/v1/kazkar/" 2>/dev/null || echo "000")
            
            if [ "$response" = "200" ] || [ "$response" = "307" ] || [ "$response" = "404" ]; then
              echo "âœ… Space is responding (HTTP $response)"
              sleep 5
              break
            fi
            
            if [ $i -eq 20 ]; then
              echo "âš ï¸ Space did not respond after 200 seconds, proceeding anyway..."
            fi
            
            sleep 10
          done

      - name: Run sync script (dry run)
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ðŸ” Running in DRY RUN mode"
          export DRY_RUN=true
          export API_URL=${{ env.API_URL }}
          node scripts/sync_legends_to_api.js

      - name: Run sync script (production)
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "ðŸš€ Running in PRODUCTION mode"
          export API_URL=${{ env.API_URL }}
          node scripts/sync_legends_to_api.js

      - name: Sync summary
        if: always()
        run: |
          echo "### Kazkar Legends Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“š **API Endpoint:** ${{ env.API_URL }}/api/v1/kazkar/import" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ¿ **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "âš ï¸ **Mode:** Dry Run (no changes made)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Mode:** Production (legends synced)" >> $GITHUB_STEP_SUMMARY
          fi

  notify-websocket:
    name: Notify WebSocket Clients
    runs-on: ubuntu-latest
    needs: sync-legends
    if: success() && github.event.inputs.dry_run != 'true'
    
    steps:
      - name: Trigger WebSocket update
        run: |
          echo "ðŸ”” Sending WebSocket notification..."
          response=$(curl -s -X POST ${{ env.API_URL }}/api/v1/kazkar/broadcast \
            -H "Content-Type: application/json" \
            -d "{\"event\": \"legends_synced\", \"timestamp\": $(date +%s), \"source\": \"github-action\"}" \
            || echo "failed")
          
          if [ "$response" != "failed" ]; then
            echo "âœ… WebSocket notification sent successfully"
          else
            echo "âš ï¸ WebSocket notification failed (may not affect deployment)"
          fi

  verify-deployment:
    name: Verify External Access
    runs-on: ubuntu-latest
    needs: sync-legends
    if: success() && github.event.inputs.dry_run != 'true'
    
    steps:
      - name: Check API availability
        run: |
          echo "ðŸ” Verifying API access..."
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.API_URL }}/api/v1/kazkar/ || echo "000")
          if [ "$response" = "200" ] || [ "$response" = "307" ]; then
            echo "âœ… API is accessible (HTTP $response)"
          else
            echo "âš ï¸ API returned HTTP $response"
            exit 1
          fi

      - name: Check legends endpoint
        run: |
          echo "ðŸ” Checking legends endpoint..."
          response=$(curl -s ${{ env.API_URL }}/api/v1/kazkar/legends | head -c 100 || echo "error")
          if [ "$response" != "error" ]; then
            echo "âœ… Legends endpoint is responding"
          else
            echo "âš ï¸ Legends endpoint may be unavailable"
          fi

      - name: Verification summary
        if: always()
        run: |
          echo "### External Access Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… API health check completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Legends endpoint verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **API Base:** ${{ env.API_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“– **Legends:** ${{ env.API_URL }}/api/v1/kazkar/legends" >> $GITHUB_STEP_SUMMARY
